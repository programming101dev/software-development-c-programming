CC = gcc
CFLAGS = -Wall -Wextra -Werror
SOURCES = main.c
BINARY = hello
REPORT_DIR = scan-results
CHECKER_REPORT_FILE = cppcheck-report.txt
SUPPORTED_SANITIZERS =

# Attempt to compile with each sanitizer to check support
CHECK_SANITIZER = \
   $(shell echo "int main(){}" > sanitizer_check.c; \
   if $(CC) $(1) sanitizer_check.c -o /dev/null > /dev/null 2>&1; then echo $(1); fi; \
   rm -f sanitizer_check.c)

SUPPORTED_SANITIZERS += $(call CHECK_SANITIZER,-fsanitize=address)
SUPPORTED_SANITIZERS += $(call CHECK_SANITIZER,-fsanitize=undefined)
SUPPORTED_SANITIZERS += $(call CHECK_SANITIZER,-fsanitize=leak)

ifeq ($(CC), gcc)
   ANALYSIS_FLAGS = -fanalyzer
   ANALYZER =
   ANALYZER_FLAGS =
else ifeq ($(CC), clang)
   ANALYSIS_FLAGS = --analyze
   ANALYZER = scan-build
   ANALYZER_FLAGS = -plist-html -o $(REPORT_DIR)
endif

$(BINARY): $(SOURCES)
	$(CC) $(CFLAGS) $(SUPPORTED_SANITIZERS) -o $(BINARY) $(SOURCES)

analyze:
	$(ANALYZER) $(ANALYZER_FLAGS) $(CC) $(CFLAGS) $(ANALYSIS_FLAGS) $(SOURCES) -c

clang-tidy:
	clang-tidy $(SOURCES) -quiet -checks='*,-llvmlibc-restrict-system-libc-headers' -- $(CFLAGS)

clean:
	rm -f $(BINARY)
	rm -f $(CHECKER_REPORT_FILE)
	rm -rf $(REPORT_DIR)
	find . -name '*.plist' -delete
	find . -name '*.o' -delete

